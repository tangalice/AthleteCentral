rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ======================= HELPERS (syntactically valid) ======================= */

    function isAuthed() {
      return request.auth != null;
    }

    function isVerifiedUser() {
      return isAuthed() && request.auth.token.email_verified == true;
    }

    function isOwner(userId) {
      return isAuthed() && request.auth.uid == userId;
    }

    function isCoach(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) &&
        get(/databases/$(database)/documents/users/$(uid)).data.role == "coach";
    }

    function isParticipant(participants) {
      return isAuthed() &&
             participants != null &&
             participants.hasAny([request.auth.uid]);
    }

    /* Can only check team membership INSIDE a match block â€” cannot use function args */

    /* ======================= USERS COLLECTION ======================= */
    match /users/{userId} {

			allow read: if isAuthed();
      
      /* ------------------ READ: only self, teammates, or coaches ------------------ */
      allow read: if isVerifiedUser() &&
                  (
                    request.auth.uid == userId ||                                           // self
                    (
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&  // requester exists
                      exists(/databases/$(database)/documents/users/$(userId)) &&            // target exists
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId != null &&
                      get(/databases/$(database)/documents/users/$(userId)).data.teamId != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId ==
                      get(/databases/$(database)/documents/users/$(userId)).data.teamId      // same team
                    )
                  );

      /* Owners can update/delete self */
      allow update, delete: if isOwner(userId);
      allow create: if isOwner(userId);

      /* Coaches may update athlete health */
      allow update: if isVerifiedUser() &&
                    isCoach(request.auth.uid) &&
                    request.auth.uid != userId &&
                    resource.data.diff(request.resource.data).changedKeys()
                      .hasOnly(["healthStatus", "healthStatusUpdatedAt"]) &&
                    (request.resource.data.healthStatus in ["active", "injured", "unavailable"]);


      /* =================== SUBCOLLECTIONS =================== */

      /* ---- Goals ---- */
      match /goalsList/{goalId} {
        allow read, write: if isOwner(userId);
        allow create, read, delete: if isVerifiedUser() && isCoach(request.auth.uid);
      }
      
      /* ---- Notifications (Coach in-app alerts) ---- */
      match /notifications/{notificationId} {
        allow read, delete: if isOwner(userId);

        allow create: if isAuthed() && (
          request.auth.uid == userId || (
            request.resource.data.type == "goalCompleted" &&
            request.resource.data.athleteId == request.auth.uid
          )
        );
      }

      /* ---- Feedback ---- */
      match /feedbackList/{feedbackId} {
        allow read, update: if isOwner(userId);
        allow create: if isVerifiedUser() && isCoach(request.auth.uid);
      }

      /* ---- Sessions ---- */
      match /sessions/{sessionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update, delete: if isOwner(userId);
      }

      /* ---- Test Performances ---- */
      match /testPerformances/{testId} {
      	allow read: if isAuthed();
        allow read: if isVerifiedUser() &&
                    (
                      isOwner(userId) ||
                      (
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        exists(/databases/$(database)/documents/users/$(userId)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId ==
                        get(/databases/$(database)/documents/users/$(userId)).data.teamId
                      )
                    );

        allow create: if isOwner(userId) ||
                      (isVerifiedUser() && isCoach(request.auth.uid) &&
                       request.resource.data.userId == userId);

        allow update, delete: if isOwner(userId) ||
                              (isVerifiedUser() && isCoach(request.auth.uid));
      }

      /* ---- Performances (Competition Results) ---- */
      match /performances/{performanceId} {
      allow read: if isAuthed();
        allow read: if isVerifiedUser() &&
                     (
                       isOwner(userId) ||
                       (
                         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                         exists(/databases/$(database)/documents/users/$(userId)) &&
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId ==
                         get(/databases/$(database)/documents/users/$(userId)).data.teamId
                       )
                     );

        allow create, update, delete: if isOwner(userId) ||
                                      (isVerifiedUser() && isCoach(request.auth.uid));
      }

      /* ---- Practices ---- */
      match /practices/{practiceId} {
      	allow read: if isAuthed();
        allow read: if isOwner(userId);
        allow read: if isVerifiedUser() && isCoach(request.auth.uid);
        allow create, update, delete: if isOwner(userId) ||
                                      (isVerifiedUser() && isCoach(request.auth.uid));
      }

      /* ---- Weight Data ---- */
      match /weightData/{weightId} {
        allow read, write: if isOwner(userId);
        allow read: if isVerifiedUser() && isCoach(request.auth.uid);
      }

      /* ---- Predictions ---- */
      match /predictions/{predictionId} {
      	allow read: if isAuthed();
        allow read: if isVerifiedUser() &&
                     (
                       isOwner(userId) ||
                       (
                         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                         exists(/databases/$(database)/documents/users/$(userId)) &&
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId ==
                         get(/databases/$(database)/documents/users/$(userId)).data.teamId
                       )
                     );

        allow write: if isOwner(userId);
      }

      /* ---- Saved Reports ---- */
      match /savedReports/{reportId} {
        allow create, read: if isOwner(userId) && isCoach(request.auth.uid);
        allow update, delete: if isOwner(userId);
      }
    }


    /* ======================= REMAINDER OF YOUR RULES (unchanged) ======================= */

    match /performances/{performanceId} {
    	allow read: if isAuthed();
      allow read: if isVerifiedUser();
      allow create, update, delete: if isVerifiedUser() && isCoach(request.auth.uid);
    }

    match /chats/{chatId} {
      allow read: if isParticipant(resource.data.participants);
      allow create: if isParticipant(request.resource.data.participants) &&
                    request.resource.data.participants.size() >= 2;
      allow update, delete: if isParticipant(resource.data.participants);
    }

    match /messages/{messageId} {
      allow read: if isAuthed();
      allow create: if isAuthed() &&
                    request.auth.uid == request.resource.data.senderId &&
                    request.resource.data.timestamp != null;
      allow update, delete: if isAuthed() &&
                             request.auth.uid == resource.data.senderId;
    }

    match /teams/{teamId} {
      allow read: if isAuthed();
      allow create: if isVerifiedUser() &&
                    request.auth.uid in request.resource.data.members &&
                    request.resource.data.createdBy == request.auth.uid;

      allow update: if isVerifiedUser();

      allow delete: if isVerifiedUser() &&
                     (
                       resource.data.createdBy == request.auth.uid ||
                       (
                         exists(/databases/$(database)/documents/teams/$(teamId)) &&
                         request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.coaches
                       )
                     );

      match /events/{eventId} {
        allow read: if exists(/databases/$(database)/documents/teams/$(teamId)) &&
                     request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.members;

        allow create: if isCoach(request.auth.uid);
        allow update, delete: if isCoach(request.auth.uid);

        match /attendance/{attendanceId} {
          allow read, create, update, delete: if isCoach(request.auth.uid);
        }
        
        match /reflections/{athleteId} {
        allow read: if exists(/databases/$(database)/documents/teams/$(teamId)) &&
                    request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.members &&
                    (
                        athleteId == request.auth.uid || 
                        isCoach(request.auth.uid)
                    );

        allow create, update: if isVerifiedUser() && 
                              !isCoach(request.auth.uid) && 
                              athleteId == request.auth.uid;

        allow update: if isVerifiedUser() && 
                      isCoach(request.auth.uid) &&
                      request.auth.uid != athleteId &&
                      request.resource.data.keys().hasOnly(['coachFeedbackUpdatedAt']); 
    
        
        match /coachFeedback/{coachId} {
            allow read: if exists(/databases/$(database)/documents/teams/$(teamId)) &&
                        request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.members;

            allow write: if isVerifiedUser() && 
                         isCoach(request.auth.uid) &&
                         coachId == request.auth.uid;
        }
    	}
      }
    }
    
        match /workouts/{workoutId} {
      // Allow read if user is part of the same team as the workout
      // For collection queries, Firestore evaluates this rule for each document
      allow read: if isAuthed() &&
                  (
                    // User is the owner of the workout
                    request.auth.uid == resource.data.userId ||
                    // User is part of the same team (check members, athletes, or coaches arrays)
                    (
                      resource.data.teamId != null &&
                      exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
                      (
                        request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.members ||
                        request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.athletes ||
                        request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.coaches
                      )
                    )
                  );

      // Allow athletes to create workouts for themselves
      allow create: if isAuthed() &&
                    !isCoach(request.auth.uid) &&
                    request.auth.uid == request.resource.data.userId &&
                    request.resource.data.teamId != null &&
                    (
                      // User must be part of the team they're logging the workout for
                      (
                        exists(/databases/$(database)/documents/teams/$(request.resource.data.teamId)) &&
                        (
                          request.auth.uid in get(/databases/$(database)/documents/teams/$(request.resource.data.teamId)).data.members ||
                          request.auth.uid in get(/databases/$(database)/documents/teams/$(request.resource.data.teamId)).data.athletes
                        )
                      )
                    );

      // Allow athletes to update/delete their own workouts
      allow update, delete: if isAuthed() &&
                             request.auth.uid == resource.data.userId;

      // Allow coaches to read workouts from their teams (already covered in read rule above)
    }

    match /feedbackPolls/{pollId} {
      allow read: if isVerifiedUser();
      allow create, update, delete: if isCoach(request.auth.uid);

      match /responses/{responseId} {
        allow create, update: if isVerifiedUser() &&
                              !isCoach(request.auth.uid) &&
                              request.auth.uid == responseId;

        allow read: if isVerifiedUser() &&
                    (request.auth.uid == responseId || isCoach(request.auth.uid));

        allow delete: if isCoach(request.auth.uid);
      }
    }
    
    match /teamPolls/{pollId} {
      allow read: if isVerifiedUser();

      allow create, update, delete: if isVerifiedUser() && isCoach(request.auth.uid);

      allow update: if isVerifiedUser() && !isCoach(request.auth.uid);

      match /responses/{odUserId} {
        allow read: if isVerifiedUser() &&
                    (request.auth.uid == odUserId || isCoach(request.auth.uid));

        allow create, update: if isVerifiedUser() &&
                              !isCoach(request.auth.uid) &&
                              request.auth.uid == odUserId;

        allow delete: if isCoach(request.auth.uid);
      }
    }



    match /athleteAvailability/{availabilityId} {
      allow read: if isVerifiedUser();
      allow create, update, delete: if isCoach(request.auth.uid);
    }

    match /mail/{id} {
      allow create: if isAuthed();
      allow read: if false;
    }

    match /public/{doc=**} {
      allow read: if true;
      allow write: if false;
    }

    match /sharedHealthStatus/{athleteId} {
      allow read, write, create: if isCoach(request.auth.uid);
    }

    match /admin/{doc=**} {
      allow read, write: if false;
    }
  }
}
